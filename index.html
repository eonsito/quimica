<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuimiLab Pro | GitHub Edition</title>
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #molOutput svg { width: 100%; height: 320px; transition: all 0.3s; }
        .mol-card:hover svg { transform: scale(1.05); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div class="max-w-5xl mx-auto p-4 py-10">
        <div class="bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
            
            <div class="bg-indigo-600 p-8 text-white">
                <h1 class="text-4xl font-black tracking-tight mb-2">QuimiLab v4.0</h1>
                <p id="status" class="text-indigo-100 font-medium">Cargando motor RDKit...</p>
            </div>

            <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 uppercase mb-3">Nombre IUPAC (Soporta Español)</label>
                        <div class="flex gap-2">
                            <input type="text" id="chemInput" placeholder="Ej: 4-metil-trans-2-hexeno" 
                                   class="flex-1 bg-slate-100 border-2 border-transparent focus:border-indigo-500 p-4 rounded-2xl outline-none transition-all">
                            <button onclick="buscarMol()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 rounded-2xl font-bold transition-all shadow-lg flex items-center gap-2">
                                <span>Graficar</span>
                                <div id="spinner" class="loader hidden"></div>
                            </button>
                        </div>
                    </div>

                    <div id="infoCard" class="hidden bg-indigo-50 p-6 rounded-3xl border border-indigo-100">
                        <h3 class="font-black text-indigo-900 mb-4 uppercase text-xs">Análisis de la Estructura</h3>
                        <div id="pasos" class="space-y-3 text-indigo-800 text-sm italic"></div>
                    </div>
                </div>

                <div class="bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 p-4 flex flex-col items-center justify-center min-h-[350px]">
                    <div id="molOutput" class="w-full flex justify-center">
                        <div class="text-center text-slate-300">
                            <p class="text-5xl">⌬</p>
                            <p class="mt-2 font-medium">La estructura aparecerá aquí</p>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <h2 id="molNombre" class="text-2xl font-black text-slate-800 uppercase"></h2>
                        <p id="molFormula" class="text-indigo-600 font-mono font-bold"></p>
                    </div>
                </div>

            </div>

            <div class="p-8 border-t border-slate-100 bg-slate-50/50">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Moléculas Guardadas</h3>
                <div id="historial" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        let RDKit;
        let storage = JSON.parse(localStorage.getItem('quimi_v4_data') || '[]');

        // Inicialización
        initRDKitModule().then(res => {
            RDKit = res;
            document.getElementById('status').innerText = "✓ Motor Químico Listo (Online)";
            renderHistorial();
        });

        function traducir(n) {
            return n.toLowerCase()
                .replace(/metil/g, 'methyl').replace(/etil/g, 'ethyl')
                .replace(/propil/g, 'propyl').replace(/butil/g, 'butyl')
                .replace(/pentil/g, 'pentyl').replace(/hexil/g, 'hexyl')
                .replace(/ano/g, 'ane').replace(/eno/g, 'ene').replace(/ino/g, 'yne')
                .replace(/ácido /g, '').replace(/oico/g, 'oic acid')
                .replace(/ciclo/g, 'cyclo');
        }

        async function buscarMol() {
            const input = document.getElementById('chemInput').value.trim();
            if (!input) return;

            const spinner = document.getElementById('spinner');
            const molOutput = document.getElementById('molOutput');
            spinner.classList.remove('hidden');

            const ingles = traducir(input);
            
            // USAMOS PUBCHEM API (Más estable)
            const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(ingles)}/property/IsomericSMILES,MolecularFormula/JSON`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("No encontrado");
                
                const data = await response.json();
                const props = data.PropertyTable.Properties[0];
                
                graficar(props.IsomericSMILES, input, props.MolecularFormula);
            } catch (err) {
                // PLAN B: Intentar con una API de respaldo si PubChem falla
                const urlBackup = `https://cactus.nci.nih.gov/chemical/structure/${encodeURIComponent(ingles)}/smiles`;
                try {
                    const resB = await fetch(urlBackup);
                    const smilesB = await resB.text();
                    if(smilesB.includes("HTML")) throw new Error();
                    graficar(smilesB, input, "C?H?");
                } catch(e) {
                    alert("No pudimos encontrar '"+input+"'. Revisa si el nombre IUPAC es correcto.");
                }
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function graficar(smiles, nombre, formula) {
            const mol = RDKit.get_mol(smiles);
            const svg = mol.get_svg();
            
            document.getElementById('molOutput').innerHTML = svg;
            document.getElementById('molNombre').innerText = nombre;
            document.getElementById('molFormula').innerText = formula;
            document.getElementById('infoCard').classList.remove('hidden');

            // Explicación didáctica
            const pasos = [];
            if(nombre.includes('trans') || nombre.includes('cis')) pasos.push("• Se detectó <b>isomería geométrica</b>.");
            if(nombre.includes('eno')) pasos.push("• Contiene <b>dobles enlaces</b> (Alqueno).");
            if(nombre.includes('metil')) pasos.push("• Presenta un grupo <b>metilo</b> lateral.");
            if(nombre.includes('ciclo')) pasos.push("• Estructura de <b>cadena cerrada</b>.");
            document.getElementById('pasos').innerHTML = pasos.join('<br>') || "• Estructura orgánica estándar analizada.";

            // Guardar
            if(!storage.find(x => x.n === nombre)) {
                storage.unshift({n: nombre, s: svg});
                storage = storage.slice(0, 10);
                localStorage.setItem('quimi_v4_data', JSON.stringify(storage));
                renderHistorial();
            }
            mol.delete();
        }

        function renderHistorial() {
            const container = document.getElementById('historial');
            container.innerHTML = storage.map(i => `
                <div class="bg-white p-2 rounded-2xl border border-slate-200 text-center mol-card transition-all">
                    <div class="h-16 overflow-hidden">${i.s}</div>
                    <p class="text-[9px] font-black truncate uppercase mt-1 text-slate-500">${i.n}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
